@page "/offers/{OfferId:int}/items"
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IDialogService DialogService

<MudGrid>
    <MudItem xs="12">
        <MudButton Color="Color.Primary" OnClick="OpenCreateDialog">Add Offer Item</MudButton>
        <MudTable Items="@orderItems" Striped="true" Hover="true" Bordered="true" PaginationSize="5"
                  @bind-CurrentPage="@currentPage" PageSize="@pageSize" TotalItems="@totalOfferItems">
            <HeaderContent>
                <MudTh>Item ID</MudTh>
                <MudTh>Article Name</MudTh>
                <MudTh>Unit Price</MudTh>
                <MudTh>Quantity</MudTh>
                <MudTh>Total Price</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.ItemId</MudTd>
                <MudTd>@context.ArticleName</MudTd>
                <MudTd>@context.UnitPrice.ToString("C")</MudTd>
                <MudTd>@context.Quantity</MudTd>
                <MudTd>@context.TotalPrice.ToString("C")</MudTd>
                <MudTd>
                    <MudButton Color="Color.Primary" OnClick="@(() => OpenEditDialog(@context))">Edit</MudButton>
                    <MudButton Color="Color.Secondary" OnClick="@(() => DeleteOfferItem(@context.ItemId))">Delete</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
</MudGrid>

<MudPagination @bind-Page="currentPage" PageCount="totalPages" />

@code {
    [Parameter] public int OfferId { get; set; }

    private List<OfferItemDto> orderItems = new();
    private int currentPage = 1;
    private const int pageSize = 5;
    private int totalOfferItems;
    private int totalPages;

    protected override async Task OnInitializedAsync()
    {
        await LoadOfferItems();
    }

    private async Task LoadOfferItems()
    {
        var response = await Http.GetFromJsonAsync<GetOfferItemsResponse>($"/offers/{OfferId}/items?pageNumber={currentPage}&pageSize={pageSize}");
        if (response != null)
        {
            orderItems = response.OfferItems;
            totalOfferItems = response.TotalCount;
            totalPages = (int)Math.Ceiling((double)totalOfferItems / pageSize);
        }
    }

    private async Task OnPageChanged(int newPage)
    {
        currentPage = newPage;
        await LoadOfferItems();
    }

    private async Task OpenCreateDialog()
    {
        var offerItem = new OfferItemDto();
        offerItem.OfferId = OfferId;
        var parameters = new DialogParameters { { "OfferItem", offerItem}, { "IsEditMode", false } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullScreen = true };
        var dialog = DialogService.Show<OfferItemDialog>("Add Offer Item", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var newItem = result.Data as OfferItemDto;
            await CreateOfferItem(newItem);
        }
    }

    private async Task OpenEditDialog(OfferItemDto item)
    {
        item.OfferId = OfferId;
        var parameters = new DialogParameters { { "OfferItem", item }, { "IsEditMode", true } };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullScreen = true };
        var dialog = DialogService.Show<OfferItemDialog>("Edit Offer Item", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var updatedItem = result.Data as OfferItemDto;
            await UpdateOfferItem(updatedItem);
        }
    }

    private async Task CreateOfferItem(OfferItemDto newItem)
    {
        var response = await Http.PostAsJsonAsync($"/offers/{OfferId}/items", newItem);
        if (response.IsSuccessStatusCode)
        {
            await LoadOfferItems();
        }
    }

    private async Task UpdateOfferItem(OfferItemDto updatedItem)
    {
        var response = await Http.PutAsJsonAsync($"/items", updatedItem);
        if (response.IsSuccessStatusCode)
        {
            await LoadOfferItems();
        }
    }

    private async Task DeleteOfferItem(int itemId)
    {
        var response = await Http.DeleteAsync($"/items/{itemId}");
        if (response.IsSuccessStatusCode)
        {
            await LoadOfferItems();
        }
    }
}
